--[[
    GROW-A-GARDEN STYLE - AUTO TRADE (SAFE FOR YOUR OWN GAME)
    Client + Server unified script (split at runtime).
    Use ONLY in a game you own/control. Do NOT attempt to use in other developers' games.
    Features:
      - ReplicatedStorage.GameEvents setup (Trade_RE, Notification)
      - Client UI (dark theme) with dropdown target, select pets, trade all / selected
      - Server handler that validates and moves Tool instances from sender -> receiver
      - Notifications to both sender & receiver
--]]

-----------------------
-- SHARED (CREATES EVENTS IF MISSING)
-----------------------
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local GameEvents = ReplicatedStorage:FindFirstChild("GameEvents")
if not GameEvents then
    GameEvents = Instance.new("Folder")
    GameEvents.Name = "GameEvents"
    GameEvents.Parent = ReplicatedStorage
end

local Trade_RE = GameEvents:FindFirstChild("Trade_RE")
if not Trade_RE then
    Trade_RE = Instance.new("RemoteEvent")
    Trade_RE.Name = "Trade_RE"
    Trade_RE.Parent = GameEvents
end

local Notification = GameEvents:FindFirstChild("Notification")
if not Notification then
    Notification = Instance.new("RemoteEvent")
    Notification.Name = "Notification"
    Notification.Parent = GameEvents
end

-----------------------
-- SERVER SIDE: Trade handler (runs only on server)
-----------------------
if RunService:IsServer() then
    -- Utility: find player by name or by Player object
    local function resolvePlayer(value)
        if typeof(value) == "Instance" and value:IsA("Player") then
            return value
        elseif typeof(value) == "string" then
            return Players:FindFirstChild(value)
        end
        return nil
    end

    Trade_RE.OnServerEvent:Connect(function(sender, data)
        -- Expect data to be table: { Action = "GivePet", Target = <Player or name>, PetName = "ToolName" }
        if typeof(data) ~= "table" then
            -- Optionally notify sender
            Notification:FireClient(sender, "Invalid trade payload.")
            return
        end

        if data.Action ~= "GivePet" and data.Action ~= "GiftPet" then
            Notification:FireClient(sender, "Unsupported action.")
            return
        end

        local target = resolvePlayer(data.Target)
        local petName = data.PetName

        if not (sender and target and target:IsA("Player")) then
            Notification:FireClient(sender, "Target not found.")
            return
        end
        if sender == target then
            Notification:FireClient(sender, "Cannot trade to yourself.")
            return
        end

        local senderBackpack = sender:FindFirstChildOfClass("Backpack")
        local targetBackpack = target:FindFirstChildOfClass("Backpack")
        if not (senderBackpack and targetBackpack) then
            Notification:FireClient(sender, "Backpack missing (sender/target).")
            return
        end

        -- Find the pet/tool either in Backpack or Character (equipped)
        local petTool = senderBackpack:FindFirstChild(petName) or (sender.Character and sender.Character:FindFirstChild(petName))
        if not petTool or not petTool:IsA("Tool") then
            Notification:FireClient(sender, "Pet not found: ".. tostring(petName))
            return
        end

        -- Security: optional validation hook (you can extend)
        -- e.g., check if tool has a specific tag or child (like "Pet Local Script") to ensure it's a pet
        if not petTool:FindFirstChild("Pet Local Script") and not petTool:FindFirstChildWhichIsA then
            -- Not strictly rejecting â€” you can customize validation. For now we allow transfer.
        end

        -- Transfer: move the actual Instance from sender -> target backpack
        -- Note: this performs a direct move. You could optionally Clone() instead if you want different behavior.
        local success, err = pcall(function()
            petTool.Parent = targetBackpack
        end)
        if not success then
            Notification:FireClient(sender, "Failed to transfer: ".. (err or "unknown"))
            return
        end

        -- Notify both players
        Notification:FireClient(sender, "Traded '" .. petName .. "' to " .. target.Name)
        Notification:FireClient(target, "You received '" .. petName .. "' from " .. sender.Name)
    end)

    -- Optional: helper for server console
    print("[AutoTrade] Server handler active - ready to accept structured trade requests.")
    return
end

-----------------------
-- CLIENT SIDE: UI + logic (runs only on client)
-----------------------
if RunService:IsClient() then
    local LocalPlayer = Players.LocalPlayer
    local UserInputService = game:GetService("UserInputService")

    -- Config (global so user can tweak target name from console)
    getgenv().AutoTradeConfig = getgenv().AutoTradeConfig or {
        targetUsername = "",
        tradeWholeInventory = false,
        selectedPets = {}
    }
    local config = getgenv().AutoTradeConfig

    -- Create UI (dark theme, draggable, minimize)
    local CoreGui = game:GetService("CoreGui")
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "GAG_AutoTrade_UI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = CoreGui

    local main = Instance.new("Frame")
    main.Name = "Main"
    main.Size = UDim2.fromOffset(380, 480)
    main.Position = UDim2.new(0.5, -190, 0.5, -240)
    main.AnchorPoint = Vector2.new(0.5, 0.5)
    main.BackgroundColor3 = Color3.fromRGB(25,25,25)
    main.Parent = ScreenGui
    main.Active = true
    main.Draggable = true
    Instance.new("UICorner", main).CornerRadius = UDim.new(0,12)

    local title = Instance.new("TextLabel")
    title.Parent = main
    title.Size = UDim2.new(1,0,0,34)
    title.Position = UDim2.new(0,0,0,0)
    title.BackgroundColor3 = Color3.fromRGB(40,40,40)
    title.Text = "GAG-Style Auto Trade (Your Game)"
    title.TextColor3 = Color3.fromRGB(255,255,255)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 18
    Instance.new("UICorner", title).CornerRadius = UDim.new(0,12)

    -- Minimize button
    local minimizeBtn = Instance.new("TextButton")
    minimizeBtn.Parent = main
    minimizeBtn.Size = UDim2.fromOffset(30,30)
    minimizeBtn.Position = UDim2.new(1,-36,0,2)
    minimizeBtn.Text = "-"
    minimizeBtn.Font = Enum.Font.GothamBold
    minimizeBtn.TextSize = 20
    minimizeBtn.BackgroundColor3 = Color3.fromRGB(65,65,65)
    minimizeBtn.TextColor3 = Color3.fromRGB(255,255,255)
    Instance.new("UICorner", minimizeBtn).CornerRadius = UDim.new(0,6)

    local minimized = false
    local function setMinimized(v)
        minimized = v
        for _,child in ipairs(main:GetChildren()) do
            if child ~= title and child ~= minimizeBtn then
                child.Visible = not minimized
            end
        end
        minimizeBtn.Text = minimized and "+" or "-"
        main.Size = minimized and UDim2.fromOffset(380,40) or UDim2.fromOffset(380,480)
    end

    minimizeBtn.MouseButton1Click:Connect(function()
        setMinimized(not minimized)
    end)

    -- Target dropdown
    local dropdown = Instance.new("Frame")
    dropdown.Parent = main
    dropdown.Size = UDim2.new(1,-24,0,40)
    dropdown.Position = UDim2.new(0,12,0,44)
    dropdown.BackgroundColor3 = Color3.fromRGB(35,35,35)
    Instance.new("UICorner", dropdown).CornerRadius = UDim.new(0,8)

    local dropLabel = Instance.new("TextButton")
    dropLabel.Parent = dropdown
    dropLabel.Size = UDim2.fromScale(1,1)
    dropLabel.Text = "Select target player"
    dropLabel.Font = Enum.Font.Gotham
    dropLabel.TextSize = 16
    dropLabel.TextColor3 = Color3.fromRGB(255,255,255)
    dropLabel.BackgroundTransparency = 1

    local dropList = Instance.new("ScrollingFrame")
    dropList.Parent = dropdown
    dropList.Size = UDim2.new(1,0,0,0)
    dropList.Position = UDim2.new(0,0,1,2)
    dropList.BackgroundColor3 = Color3.fromRGB(45,45,45)
    dropList.BorderSizePixel = 0
    dropList.ScrollBarThickness = 6
    dropList.Visible = false
    Instance.new("UICorner", dropList).CornerRadius = UDim.new(0,8)

    local dropLayout = Instance.new("UIListLayout")
    dropLayout.Parent = dropList
    dropLayout.Padding = UDim.new(0,2)

    local function refreshPlayerList()
        for _,c in ipairs(dropList:GetChildren()) do
            if c:IsA("TextButton") then c:Destroy() end
        end
        for _,p in ipairs(Players:GetPlayers()) do
            if p ~= LocalPlayer then
                local btn = Instance.new("TextButton")
                btn.Parent = dropList
                btn.Size = UDim2.new(1,0,0,26)
                btn.Text = p.Name
                btn.Font = Enum.Font.Gotham
                btn.TextSize = 14
                btn.TextColor3 = Color3.fromRGB(255,255,255)
                btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
                btn.MouseButton1Click:Connect(function()
                    config.targetUsername = p.Name
                    dropLabel.Text = "Target: " .. p.Name
                    dropList.Visible = false
                    dropList.Size = UDim2.new(1,0,0,0)
                end)
            end
        end
    end

    dropLabel.MouseButton1Click:Connect(function()
        dropList.Visible = not dropList.Visible
        refreshPlayerList()
        if dropList.Visible then
            dropList.Size = UDim2.new(1,0,0, math.clamp(#Players:GetPlayers()*26, 26, 260))
        else
            dropList.Size = UDim2.new(1,0,0,0)
        end
    end)

    Players.PlayerAdded:Connect(function() refreshPlayerList() end)
    Players.PlayerRemoving:Connect(function() refreshPlayerList() end)

    -- Pet list area
    local petFrame = Instance.new("ScrollingFrame")
    petFrame.Parent = main
    petFrame.Size = UDim2.new(1,-24,1, -240)
    petFrame.Position = UDim2.new(0,12,0,96)
    petFrame.BackgroundColor3 = Color3.fromRGB(35,35,35)
    petFrame.BorderSizePixel = 0
    petFrame.ScrollBarThickness = 6
    Instance.new("UICorner", petFrame).CornerRadius = UDim.new(0,8)

    local petLayout = Instance.new("UIListLayout")
    petLayout.Parent = petFrame
    petLayout.Padding = UDim.new(0,6)

    local function refreshPetList()
        for _,c in ipairs(petFrame:GetChildren()) do
            if c:IsA("TextButton") then c:Destroy() end
        end
        local backpack = LocalPlayer:FindFirstChildOfClass("Backpack")
        if not backpack then return end
        for _,tool in ipairs(backpack:GetChildren()) do
            if tool:IsA("Tool") then
                local btn = Instance.new("TextButton")
                btn.Parent = petFrame
                btn.Size = UDim2.new(1,0,0,30)
                btn.Text = tool.Name
                btn.Font = Enum.Font.Gotham
                btn.TextSize = 14
                btn.TextColor3 = Color3.fromRGB(255,255,255)
                btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
                Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)
                btn.MouseButton1Click:Connect(function()
                    local idx = table.find(config.selectedPets, tool.Name)
                    if idx then
                        table.remove(config.selectedPets, idx)
                        btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
                    else
                        table.insert(config.selectedPets, tool.Name)
                        btn.BackgroundColor3 = Color3.fromRGB(35,140,70)
                    end
                end)
            end
        end
    end

    refreshPetList()
    LocalPlayer.Backpack.ChildAdded:Connect(refreshPetList)
    LocalPlayer.Backpack.ChildRemoved:Connect(refreshPetList)

    -- Controls (toggle all + start)
    local toggleAll = Instance.new("TextButton")
    toggleAll.Parent = main
    toggleAll.Size = UDim2.new(1,-24,0,40)
    toggleAll.Position = UDim2.new(0,12,1,-130)
    toggleAll.Text = "Trade Full Inventory: OFF"
    toggleAll.Font = Enum.Font.Gotham
    toggleAll.TextSize = 16
    toggleAll.BackgroundColor3 = Color3.fromRGB(60,60,60)
    toggleAll.TextColor3 = Color3.fromRGB(255,255,255)
    Instance.new("UICorner", toggleAll).CornerRadius = UDim.new(0,8)

    local startBtn = Instance.new("TextButton")
    startBtn.Parent = main
    startBtn.Size = UDim2.new(1,-24,0,46)
    startBtn.Position = UDim2.new(0,12,1,-78)
    startBtn.Text = "Start Trading"
    startBtn.Font = Enum.Font.GothamBold
    startBtn.TextSize = 18
    startBtn.BackgroundColor3 = Color3.fromRGB(90,90,90)
    startBtn.TextColor3 = Color3.fromRGB(255,255,255)
    Instance.new("UICorner", startBtn).CornerRadius = UDim.new(0,8)

    local status = Instance.new("TextLabel")
    status.Parent = main
    status.Size = UDim2.new(1,-24,0,20)
    status.Position = UDim2.new(0,12,1,-160)
    status.BackgroundTransparency = 1
    status.Font = Enum.Font.Gotham
    status.TextSize = 14
    status.TextColor3 = Color3.fromRGB(255,255,255)
    status.Text = "Status: Idle"

    toggleAll.MouseButton1Click:Connect(function()
        config.tradeWholeInventory = not config.tradeWholeInventory
        toggleAll.Text = "Trade Full Inventory: " .. (config.tradeWholeInventory and "ON" or "OFF")
    end)

    -- send trade request to server; data uses GAG-style table
    local function sendTrade(petName, target)
        status.Text = "Sending " .. petName .. "..."
        Trade_RE:FireServer({
            Action = "GivePet",
            Target = target,       -- can be player instance or name string (server accepts both)
            PetName = petName
        })
        -- Give UI a little breathing room
        task.wait(0.35)
    end

    startBtn.MouseButton1Click:Connect(function()
        if config.targetUsername == "" then
            status.Text = "Select a target first."
            return
        end
        local targetPlayer = Players:FindFirstChild(config.targetUsername)
        if not targetPlayer then
            status.Text = "Target not found."
            return
        end

        local pets = {}
        if config.tradeWholeInventory then
            local backpack = LocalPlayer:FindFirstChildOfClass("Backpack")
            if backpack then
                for _,t in ipairs(backpack:GetChildren()) do
                    if t:IsA("Tool") then table.insert(pets, t.Name) end
                end
            end
        else
            pets = table.create(#config.selectedPets)
            for i,v in ipairs(config.selectedPets) do pets[i] = v end
        end

        if #pets == 0 then
            status.Text = "No pets selected."
            return
        end

        for _,petName in ipairs(pets) do
            sendTrade(petName, targetPlayer)
        end
        status.Text = "Trade requests sent."
    end)

    -- Listen for Notification events from server
    Notification.OnClientEvent:Connect(function(msg)
        status.Text = tostring(msg)
    end)

    -- Helpful console message
    print("[AutoTrade] Client UI loaded. Use the dropdown to choose a target and trade pets.")
end
